TODO: Can this be optimized? This takes tens of seconds
